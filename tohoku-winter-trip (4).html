<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»™å°ãƒ»å±±å½¢ å†°é›ªä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSJVNzZ1YtP_jA2rt2v6AvNITsqq5siP0",
            authDomain: "tohoku-trip.firebaseapp.com",
            databaseURL: "https://tohoku-trip-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tohoku-trip",
            storageBucket: "tohoku-trip.firebasestorage.app",
            messagingSenderId: "94149530181",
            appId: "1:94149530181:web:175b1f9b9530b45c55892c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tripRef = ref(db, 'itinerary');

        // Expose to window so Alpine can use
        window._firebaseDb = db;
        window._firebaseRef = tripRef;
        window._firebaseSet = set;
        window._firebaseOnValue = onValue;
        window._firebaseReady = true;

        // Signal Alpine that Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('tripData', () => ({
                activeDay: 'day2',
                sortableInstance: null,
                newChecklistItem: '',
                newChecklistType: 'item',
                syncStatus: 'loading',
                _saveTimer: null,
                _watcherPaused: false,
                _ignoreNextSnapshot: false,
                _dataVersion: 2,  // â† æ¯æ¬¡æ›´æ–° HTML å…§å®¹æ™‚éå¢æ­¤æ•¸å­—
                jpyRate: null,
                jpyRateDate: '',

                init() {
                    this._fetchJpyRate();
                    // Wait for Firebase then load
                    const setup = () => {
                        this._listenFirebase();
                    };
                    if (window._firebaseReady) {
                        setup();
                    } else {
                        window.addEventListener('firebase-ready', setup, { once: true });
                        // Fallback: if firebase never loads
                        setTimeout(() => {
                            if (this.syncStatus === 'loading') {
                                this.syncStatus = 'offline';
                                this._initLocal();
                            }
                        }, 5000);
                    }

                    this.$watch('activeDay', () => {
                        this.newChecklistItem = '';
                        this.newChecklistType = 'item';
                        this.$nextTick(() => this.initSortable());
                    });
                },

                _listenFirebase() {
                    window._firebaseOnValue(window._firebaseRef, (snapshot) => {
                        const cloudData = snapshot.val();

                        // If we just saved, Firebase echoes back â€” ignore it
                        if (this._ignoreNextSnapshot) {
                            this._ignoreNextSnapshot = false;
                            return;
                        }

                        if (cloudData && Array.isArray(cloudData)) {
                            const cloudVersion = cloudData._version || 0;
                            const localVersion = this._dataVersion || 1;

                            if (cloudVersion >= localVersion) {
                                // Cloud is same or newer â€” apply cloud data
                                this._watcherPaused = true;
                                this.itinerary = cloudData;
                                this._normalizeItinerary();
                                this.$nextTick(() => {
                                    this.initSortable();
                                    this._watcherPaused = false;
                                });
                            } else {
                                // Local HTML is newer â€” push local to cloud once
                                this._normalizeItinerary();
                                const clean = JSON.parse(JSON.stringify(this.itinerary));
                                clean._version = localVersion;
                                this._ignoreNextSnapshot = true;
                                window._firebaseSet(window._firebaseRef, clean);
                            }
                        } else {
                            // No cloud data yet â€” push local up
                            this._normalizeItinerary();
                            const clean = JSON.parse(JSON.stringify(this.itinerary));
                            clean._version = this._dataVersion || 1;
                            this._ignoreNextSnapshot = true;
                            window._firebaseSet(window._firebaseRef, clean);
                        }

                        if (this.syncStatus === 'loading') {
                            this.$nextTick(() => {
                                this.initSortable();
                                this._startWatcher();
                            });
                        }
                        this.syncStatus = 'synced';

                    }, (error) => {
                        console.error('Firebase error:', error);
                        this.syncStatus = 'offline';
                        this._initLocal();
                    });
                },

                _initLocal() {
                    this._normalizeItinerary();
                    this.$nextTick(() => {
                        this.initSortable();
                        this._startWatcher();
                    });
                },

                _normalizeItinerary() {
                    this.itinerary.forEach(day => {
                        if (!day.events) day.events = [];
                        if (!day.checklist) day.checklist = [];
                        if (!day.expenses) day.expenses = [];
                        day.events.forEach(event => {
                            if (!event.id) event.id = Math.random().toString(36).substr(2, 9);
                            if (!event.note) event.note = '';
                            if (!event.address) event.address = '';
                            if (!event.hours) event.hours = '';
                            if (!event.mapUrl) event.mapUrl = '';
                            if (!event.links) event.links = [];
                            if (event.expanded === undefined) event.expanded = false;
                        });
                    });
                },

                _startWatcher() {
                    this.$watch('itinerary', () => {
                        if (this._watcherPaused) return;
                        this.syncStatus = 'saving';
                        clearTimeout(this._saveTimer);
                        this._saveTimer = setTimeout(() => this._saveToFirebase(), 1500);
                    }, { deep: true });
                },

                _saveToFirebase() {
                    if (this.syncStatus === 'offline') return;
                    const clean = JSON.parse(JSON.stringify(this.itinerary));
                    clean._version = this._dataVersion || 1;
                    this._ignoreNextSnapshot = true;
                    window._firebaseSet(window._firebaseRef, clean)
                        .then(() => { this.syncStatus = 'synced'; })
                        .catch(() => {
                            this._ignoreNextSnapshot = false;
                            this.syncStatus = 'offline';
                        });
                },

                async _fetchJpyRate() {
                    try {
                        // å°ç£éŠ€è¡Œç‰Œå‘ŠåŒ¯ç‡ CSV (CORS-friendly endpoint)
                        const res = await fetch('https://rate.bot.com.tw/xchg/flcsv/0/day');
                        const text = await res.text();
                        // CSV format: å¹£åˆ¥,ç¾é‡‘è²·å…¥,ç¾é‡‘è³£å‡º,å³æœŸè²·å…¥,å³æœŸè³£å‡º,...
                        const lines = text.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('æ—¥æœ¬')) {
                                const cols = line.split(',');
                                // cols[3] = å³æœŸè²·å…¥, cols[4] = å³æœŸè³£å‡º
                                const sell = parseFloat(cols[4]);
                                if (!isNaN(sell)) {
                                    this.jpyRate = sell;
                                    this.jpyRateDate = new Date().toLocaleDateString('zh-TW');
                                }
                                break;
                            }
                        }
                    } catch (e) {
                        // CORS blocked â€” fallback: try via allorigins proxy
                        try {
                            const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://rate.bot.com.tw/xchg/flcsv/0/day');
                            const res2 = await fetch(proxy);
                            const text2 = await res2.text();
                            const lines2 = text2.split('\n');
                            for (const line of lines2) {
                                if (line.startsWith('æ—¥æœ¬')) {
                                    const cols = line.split(',');
                                    const sell = parseFloat(cols[4]);
                                    if (!isNaN(sell)) {
                                        this.jpyRate = sell;
                                        this.jpyRateDate = new Date().toLocaleDateString('zh-TW');
                                    }
                                    break;
                                }
                            }
                        } catch (e2) {
                            console.warn('åŒ¯ç‡å–å¾—å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                            this.jpyRate = 0.2195; // å‚™ç”¨åŒ¯ç‡
                            this.jpyRateDate = 'é è¨­å€¼';
                        }
                    }
                },

                toTwd(jpy) {
                    if (!this.jpyRate || !jpy) return null;
                    return Math.round(jpy * this.jpyRate);
                },

                get syncLabel() {
                    return {
                        loading: 'â³ è¼‰å…¥ä¸­â€¦',
                        saving:  'â˜ï¸ å„²å­˜ä¸­â€¦',
                        synced:  'âœ… å·²åŒæ­¥',
                        offline: 'âš ï¸ é›¢ç·šæ¨¡å¼'
                    }[this.syncStatus] || '';
                },

                get syncColor() {
                    return {
                        loading: 'text-slate-400',
                        saving:  'text-blue-500',
                        synced:  'text-emerald-600',
                        offline: 'text-amber-500'
                    }[this.syncStatus] || '';
                },

                initSortable() {
                    const el = document.getElementById('sortable-events');
                    if (!el) return;
                    if (this.sortableInstance) this.sortableInstance.destroy();
                    this.sortableInstance = Sortable.create(el, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'opacity-30',
                        onEnd: (evt) => {
                            const list = this.currentDayData.events;
                            const item = list.splice(evt.oldIndex, 1)[0];
                            list.splice(evt.newIndex, 0, item);
                        }
                    });
                },

                get currentDayData() {
                    return this.itinerary.find(d => d.id === this.activeDay);
                },

                // è§£æè²»ç”¨ï¼šNTé–‹é ­è¦–ç‚ºå°å¹£ï¼Œå…¶ä»–è¦–ç‚ºJPYè½‰å°å¹£
                parseCost(val) {
                    const s = String(val || '').trim();
                    if (/^NT\s*/i.test(s)) {
                        return { jpy: 0, twd: parseFloat(s.replace(/^NT\s*/i, '')) || 0 };
                    }
                    const jpy = parseFloat(s) || 0;
                    return { jpy, twd: Math.round(jpy * 0.21) };
                },

                _sumItems(items) {
                    return (items || []).reduce((acc, i) => {
                        const p = this.parseCost(i.cost);
                        return { jpy: acc.jpy + p.jpy, twd: acc.twd + p.twd };
                    }, { jpy: 0, twd: 0 });
                },

                get currentDayTotal() {
                    const ev = this._sumItems(this.currentDayData.events);
                    const ex = this._sumItems(this.currentDayData.expenses);
                    return { jpy: ev.jpy + ex.jpy, twd: ev.twd + ex.twd };
                },

                get totalBudget() {
                    return this.itinerary.reduce((acc, day) => {
                        const ev = this._sumItems(day.events);
                        const ex = this._sumItems(day.expenses);
                        return { jpy: acc.jpy + ev.jpy + ex.jpy, twd: acc.twd + ev.twd + ex.twd };
                    }, { jpy: 0, twd: 0 });
                },

                toggleEvent(event) {
                    event.expanded = !event.expanded;
                },

                addEvent() {
                    const newEvent = {
                        id: Math.random().toString(36).substr(2, 9),
                        time: '00:00', location: 'æ–°è¡Œç¨‹',
                        detail: 'è«‹è¼¸å…¥è¡Œç¨‹ç´°ç¯€',
                        note: '', address: '', hours: '', mapUrl: '',
                        cost: 0, links: [], expanded: true
                    };
                    this.currentDayData.events.push(newEvent);
                    this.$nextTick(() => this.initSortable());
                },

                addExpense() {
                    if (!this.currentDayData.expenses) this.currentDayData.expenses = [];
                    this.currentDayData.expenses.push({
                        id: Math.random().toString(36).substr(2, 9),
                        location: 'æ–°æ”¯å‡ºé …ç›®', cost: 0
                    });
                },

                removeEventById(id) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) {
                        const index = this.currentDayData.events.findIndex(e => e.id === id);
                        if (index !== -1) {
                            this.currentDayData.events.splice(index, 1);
                            this.$nextTick(() => this.initSortable());
                        }
                    }
                },

                removeExpenseById(id) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ”¯å‡ºå—ï¼Ÿ')) {
                        const idx = (this.currentDayData.expenses || []).findIndex(e => e.id === id);
                        if (idx !== -1) this.currentDayData.expenses.splice(idx, 1);
                    }
                },

                addChecklistItem() {
                    const val = this.newChecklistItem.trim();
                    if (val === '') return;
                    let item;
                    if (this.newChecklistType === 'category') {
                        item = 'ğŸ“Œ ' + val;
                    } else {
                        item = val;
                    }
                    this.currentDayData.checklist.push({ item, done: false });
                    this.newChecklistItem = '';
                    this.$nextTick(() => {
                        const input = document.getElementById('checklist-input-' + this.activeDay);
                        if (input) input.focus();
                    });
                },

                addItemAfterCategory(categoryIndex) {
                    const val = prompt('è¼¸å…¥æ–°é …ç›®åç¨±ï¼š');
                    if (!val || val.trim() === '') return;
                    // Insert after the category and any existing items under it
                    const list = this.currentDayData.checklist;
                    const catEmojis = ['ğŸ“‹','ğŸ“±','ğŸ’Š','ğŸ§¥','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‚','ğŸ“Œ'];
                    let insertAt = categoryIndex + 1;
                    // Skip past existing items that belong to this category
                    while (insertAt < list.length && !catEmojis.some(e => list[insertAt].item.startsWith(e))) {
                        insertAt++;
                    }
                    list.splice(insertAt, 0, { item: val.trim(), done: false });
                },
                removeChecklistItem(index) {
                    this.currentDayData.checklist.splice(index, 1);
                },

                itinerary: [
                    {
                        id: 'pre-trip', date: 'è¡Œå‰', title: 'æº–å‚™æ¸…å–®',
                        tip: 'å‡ºç™¼å‰å‹™å¿…é€é …ç¢ºèªï¼Œå°¤å…¶æ˜¯è­·ç…§æœ‰æ•ˆæœŸé™èˆ‡ç¶²è·¯è¨­å®šã€‚',
                        checklist: [
                            { item: 'ğŸ“‹ è­‰ä»¶èˆ‡ç¥¨å‹™', done: false },
                            { item: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', done: false },
                            { item: 'æ©Ÿç¥¨é›»å­æª”/æˆªåœ–å­˜æ‰‹æ©Ÿ', done: false },
                            { item: 'Visit Japan Web å¡«å¯«å®Œæˆ QR Code', done: false },
                            { item: 'æµ·å¤–æ—…éŠä¿éšª (æ—…å¹³éšª/ä¸ä¾¿éšª)', done: false },
                            { item: 'ğŸ“± é€šè¨Šèˆ‡é‡‘éŒ¢', done: false },
                            { item: 'ç¶²å¡/eSIM è¨­å®šç¢ºèª', done: false },
                            { item: 'æ—¥å¹£ç¾é‡‘æ›åŒ¯', done: false },
                            { item: 'ä¿¡ç”¨å¡ (ç¢ºèªé–‹å•Ÿæµ·å¤–äº¤æ˜“)', done: false },
                            { item: 'è¡Œå‹•é›»æº (éœ€éš¨èº«æ”œå¸¶)', done: false },
                            { item: 'ğŸ’Š é†«ç™‚', done: false },
                            { item: 'å€‹äººå¸¸å‚™è—¥å“', done: false },
                            { item: 'å°ˆæ¥­è­·è† â€” å³è† MCL æ”¯æ’å‹ (é‡å°èˆŠå‚·ä¿æº«èˆ‡åŠ å£“)', done: false },
                            { item: 'ğŸ§¥ åº•å±¤ (Base Layer)', done: false },
                            { item: 'UA ç™¼ç†±è¡£ â€” è—è‰² x1 (2/20 æ¾å³¶ä½¿ç”¨)', done: false },
                            { item: 'MONTBELL Zeoline â€” ç™½è‰² x1 (2/21 ä½¿ç”¨)', done: false },
                            { item: 'MONTBELL ç¾Šæ¯›è¡£ â€” ç²‰è‰² x1 (2/22 çƒå¸½å­æ»‘é›ªä½¿ç”¨)', done: false },
                            { item: 'WORKMAN ç¾Šæ¯›è¡£ â€” é»‘è‰²/æ·±è‰² x2 (2/23-24ã€2/28 ä½¿ç”¨)', done: false },
                            { item: 'ç¾Šæ¯›åº•å±¤è¡£ â€” ç¶ è‰² x1 (2/25-27 è—ç‹æ»‘é›ªå°ˆç”¨)', done: false },
                            { item: 'ğŸ§£ ä¸­å±¤ (Mid Layer)', done: false },
                            { item: 'åˆ·æ¯› T â€” ç²‰è‰² x1ã€é»ƒè‰² x1 (å¸‚å€èˆ‡æ™¯é»æ—¥æ›¿æ›)', done: false },
                            { item: 'Primaloft Active 95g æ©˜è‰² x1 (2/22 å‹•æ…‹æ»‘é›ªç”¨ï¼Œé«˜é€æ°£)', done: false },
                            { item: 'Primaloft Active 170g ç²‰è‰² x1 (2/25-27 è—ç‹ä½æº«ç”¨ï¼Œé«˜ä¿æš–)', done: false },
                            { item: 'ç¾½çµ¨èƒŒå¿ƒ â€” è¼•è–„å‹ x1 (ä¿éšªå±¤ï¼Œ2/23 éŠ€å±±åŠ 2/28 å±±å¯ºå¿…å‚™)', done: false },
                            { item: 'ğŸ§¤ å¤–å±¤ (Outer Layer)', done: false },
                            { item: 'Timberland é­šå°¾å¤§è¡£ â€” é»‘è‰² A6HB9001 (å¸‚å€è§€å…‰å…¨ç¨‹ä½¿ç”¨)', done: false },
                            { item: 'Protest Anorak PRTKOW â€” (2/22 çƒå¸½å­æ»‘é›ªç”¨)', done: false },
                            { item: 'Roxy é›ªè¡£å¤–å¥— â€” å°ˆæ¥­æ¬¾ (2/25-27 è—ç‹æ»‘é›ªç”¨)', done: false },
                            { item: 'ğŸ½ é…ä»¶ (Accessories)', done: false },
                            { item: 'ç¾Šæ¯›è¥ª â€” å¸‚å€ x3 é›™ã€æ»‘é›ª x3 é›™ (ä¸æ¸…æ´—ï¼Œæ¯é›™ç©¿2å¤©)', done: false },
                            { item: 'æ‰‹å¥— â€” HEAD x1 (å¸‚å€)ã€DAKINE x2 (æ»‘é›ªï¼Œç¢ºèªé˜²æ°´)', done: false },
                            { item: 'æ¯›å¸½ x2', done: false },
                            { item: 'å®‰å…¨å¸½ + é¢ç½© (è—ç‹å±±é ‚é¢¨å¤§ï¼Œé¢ç½©å¿…å¸¶)', done: false },
                            { item: '  Ride Warpig 148cm â€” ç¢ºèªå›ºå®šå™¨èºçµ²å·²é–ç·Š', done: false }
                        ],
                        events: [
                            { time: 'å»ç¨‹', location: 'è™èˆª IT254', detail: 'TPE 14:35 - SDJ 18:45', note: 'å·²ç¢ºèª', cost: 15000, links: [], expanded: false },
                            { time: 'å›ç¨‹', location: 'è™èˆª IT255', detail: 'SDJ 19:40 - TPE 23:00', note: 'å·²ç¢ºèª', cost: 0, links: [], expanded: false },
                            { time: '', location: 'ä¿éšªè²»ç”¨', detail: 'æ—…å¹³éšª+ä¸ä¾¿éšª', note: '', cost: 1200, links: [], expanded: false },
                            { time: 'å‰48H', location: 'ç·šä¸Šå ±åˆ°', detail: 'èˆªç©ºå…¬å¸å®˜ç¶²é è¾¦ç™»æ©Ÿ', note: 'é¸ä½ç¢ºèª', cost: 0, links: [], expanded: false }
                        ]
                    },
                    {
                        id: 'day1', date: '2/19', title: 'æŠµé”ä»™å°',
                        tip: 'ç­æ©ŸæŠµé”æ™‚é–“è¼ƒæ™šï¼Œå»ºè­°å‡ºé—œå¾Œç›´æ¥å‰å¾€é£¯åº—ï¼Œæ™šé¤å¯é¸æ“‡è»Šç«™å‘¨é‚Šè¼ƒæ™šæ‰“çƒŠçš„åº—å®¶ã€‚',
                        checklist: [
                            { item: 'ç¢ºèª IT254 èˆªç­å ±åˆ°æ™‚é–“', done: false },
                            { item: 'é ˜å–æ—¥å¹£ç¾é‡‘èˆ‡ç¶²å¡', done: false },
                            { item: 'ç¢ºèªé£¯åº—å…¥ä½é ç´„ä¿¡', done: false }
                        ],
                        events: [
                            { time: '18:45', location: 'ä»™å°æ©Ÿå ´', detail: 'æ­ä¹˜ IT254 æŠµé”ã€‚', note: 'å…¥å¢ƒå¯©æŸ¥èˆ‡é ˜å–è¡Œæ', cost: 0, links: [], expanded: false },
                            { time: '19:10 - 19:37', location: 'ä»™å°ç©ºæ¸¯ç·š', detail: 'æ­ä¹˜å¾€ä»™å°æ–¹å‘ï¼ŒæŠµé”ä»™å°ç«™ã€‚', note: 'è‹¥è¶•ä¸ä¸Šå¯æ­ 19:42 çš„ç­æ¬¡', cost: 660, links: [], expanded: false },
                            { time: '20:00', location: 'ç›¸éµ FRESA INN', detail: 'è¾¦ç†å…¥ä½ Check-inã€‚', note: 'æ«ƒå°åœ¨2æ¨“', cost: 0, links: [], expanded: false },
                            { time: '20:30', location: 'æ™šé¤', detail: 'ä»™å°ç«™ 3F ç‰›èˆŒé€š / å–„æ²»éƒ (è‹¥æ’éšŠäººå¤šæ”¹åƒè»Šç«™ä¾¿ç•¶æˆ–è¶…å•†)', note: 'Bic Camera 21:00 æ‰“çƒŠå¯èƒ½ä¾†ä¸åŠ', cost: 3500, links: [], expanded: false }
                        ]
                    },
                    {
                        id: 'day2', date: '2/20', title: 'æ¾å³¶èˆ‡æ¡è²·',
                        tip: 'ææ—©æ–¼ 11:00 åƒåˆé¤å¯é¿é–‹éŠè¦½åœ˜äººæ½®ã€‚',
                        checklist: [
                            { item: 'ç¢ºèªæ¾å³¶éŠè¦½èˆ¹ç­æ¬¡æ™‚é–“', done: false },
                            { item: 'æ”œå¸¶ç’°ä¿è¢‹å‰å¾€ WORKMAN', done: false }
                        ],
                        events: [
                            { time: '08:30', location: 'ä»™å°æœå¸‚', detail: 'æ—©é¤æ¨è–¦ï¼šæœå¸‚ä¸¼ã€é½‹è—¤é¤ƒå­ã€‚', note: '', address: 'ä»™å°å¸‚é’è‘‰å€ä¸­å¤® 4-3-28', hours: '08:00 - 18:00 (é€±æ—¥å…¬ä¼‘)', mapUrl: 'https://goo.gl/maps/SendaiAsaichi', cost: 0, links: [], expanded: false },
                            { time: '09:29 - 10:10', location: 'JR ä»™çŸ³ç·š', detail: 'æŠµé”æ¾å³¶æµ·å²¸ç«™ (ä¾†å›è»Šè³‡)ã€‚', note: '', cost: 840, links: [], expanded: false },
                            { time: '10:15 - 11:00', location: 'åœ“é€šé™¢', detail: 'æ¬£è³ç²¾ç·»åº­åœ’èˆ‡çµç·£è§€éŸ³ã€‚', note: '', address: 'å®®åŸç¸£å®®åŸéƒ¡æ¾å³¶ç”ºæ¾å³¶ç”ºå†…67', hours: '09:00 - 16:00', mapUrl: 'https://goo.gl/maps/Entsuin', cost: 1200, links: [], expanded: false },
                            { time: '11:00 - 12:15', location: 'æ¾å³¶é­šå¸‚å ´ (åˆé¤)', detail: 'ææ—©åƒåˆé¤ï¼Œæ¨è–¦çƒ¤ç‰¡è £å°å±‹ã€‚', note: '', address: 'å®®åŸç¸£å®®åŸéƒ¡æ¾å³¶ç”ºæ¾å³¶å­—æ™®è³¢å ‚4-10', hours: '08:00 - 17:00 (é£Ÿå ‚ 10:00-15:00)', mapUrl: 'https://goo.gl/maps/MatsushimaFishMarket', cost: 2500, links: [], expanded: false },
                            { time: '12:20 - 13:00', location: 'ç‘åš´å¯º', detail: 'ä¼Šé”æ”¿å®—è©æå¯ºï¼Œåœ‹å¯¶æœ¬å ‚ã€‚', note: '', address: 'å®®åŸç¸£å®®åŸéƒ¡æ¾å³¶ç”ºæ¾å³¶ç”ºå†…91', hours: '08:30 - 16:00', mapUrl: 'https://goo.gl/maps/Zuiganji', cost: 0, links: [], expanded: false },
                            { time: '13:10 - 13:40', location: 'äº”å¤§å ‚', detail: 'ç¶“å…¸ç´…æ©‹åœ°æ¨™æ•£ç­–ã€‚', note: '', address: 'å®®åŸç¸£å®®åŸéƒ¡æ¾å³¶ç”ºæ¾å³¶ç”ºå†…111', hours: '08:00 - 16:30', mapUrl: 'https://goo.gl/maps/Godaido', cost: 0, links: [], expanded: false },
                            { time: '14:00 - 14:50', location: 'æ¾å³¶ç£éŠèˆ¹', detail: 'æ­èˆ¹ä¼‘æ¯ï¼Œæ¬£è³æ¾å³¶ç£ç¾æ™¯ã€‚', links: [{ title: 'éŠè¦½èˆ¹æ™‚åˆ»è¡¨èˆ‡é ç´„', url: 'https://www.matsushima-kankousen.co.jp/' }], note: '', address: 'å®®åŸç¸£å®®åŸéƒ¡æ¾å³¶ç”ºæ¾å³¶ç”ºå†…98-1', hours: '09:00 - 15:00', mapUrl: 'https://goo.gl/maps/MatsushimaCruise', cost: 1500, expanded: false },
                            { time: '16:04 - 16:21', location: 'å‰å¾€ä¸­é‡æ¦®ç«™', detail: 'æ­ä¹˜ JR ä»™çŸ³ç·šã€‚', note: '', cost: 0, links: [], expanded: false },
                            { time: '16:30 - 18:30', location: 'WORKMAN ä»™å°ä¸­é‡åº—', detail: 'æ©Ÿèƒ½æœé£¾è³¼ç‰©ã€‚', note: '', address: 'ä»™å°å¸‚å®®åŸé‡å€ä¸­é‡å‡ºèŠ±è¥¿5-4-35', hours: '07:00 - 20:00', mapUrl: 'https://goo.gl/maps/WorkmanSendaiNakano', cost: 0, links: [], expanded: false },
                            { time: '19:00', location: 'è¿”å›ä»™å°', detail: 'æ™šé¤èˆ‡è£œé€› Bic Camera (æ˜¨å¤©æ²’é€›åˆ°çš„è©±)ã€‚', note: 'å£½å¸é€šã‚Š (ä»™å°ç«™ 3F)', cost: 0, links: [], expanded: false }
                        ]
                    },
                    {
                        id: 'day3', date: '2/21', title: 'ç¥ç¤¾åƒæ‹œ',
                        tip: 'é€±æœ«ç¥ç¤¾åƒæ‹œè€…å¤šï¼Œå»ºè­°ä¸­åˆå‰æŠµé”ï¼›å‹™å¿…ç¢ºèªå·´å£«å›ç¨‹æ™‚åˆ»ã€‚',
                        checklist: [
                            { item: 'æ•´ç†è¡Œææº–å‚™æ›å®¿', done: false },
                            { item: 'æŸ¥é–±å²©æ²¼ç«™å¾€è¿”ç¥ç¤¾å·´å£«æ™‚åˆ»', done: false }
                        ],
                        events: [
                            { time: '08:30', location: 'ä»™å°æœå¸‚', detail: 'æ—©é¤ã€‚', note: '', address: 'ä»™å°å¸‚é’è‘‰å€ä¸­å¤® 4-3-28', hours: '08:00 - 18:00 (é€±æ—¥å…¬ä¼‘)', mapUrl: 'https://goo.gl/maps/SendaiAsaichi', cost: 0, links: [], expanded: false },
                            { time: 'ä¸Šåˆ', location: 'æ±æ©«INN ä»™å°ç«™è¥¿å£ä¸­å¤®', detail: 'è¾¦ç†é€€æˆ¿ï¼Œè¡Œæç§»è‡³æ–°é£¯åº—ã€‚', note: '', cost: 0, links: [], expanded: false },
                            { time: 'ä¸‹åˆ', location: 'JR æ±åŒ—æœ¬ç·š', detail: 'ä»™å°ç«™å¾€è¿”å²©æ²¼ç«™è»Šè³‡ã€‚', note: '', cost: 680, links: [], expanded: false },
                            { time: 'ä¸‹åˆ', location: 'é‡‘è›‡æ°´ç¥ç¤¾', detail: 'è½‰ä¹˜è¨ˆç¨‹è»Šæˆ–å¸‚ç‡Ÿå·´å£«åƒæ‹œã€‚ç¥ˆæ±‚è²¡é‹èˆ‡äº‹æ¥­ã€‚', links: [{ title: 'é‡‘è›‡æ°´ç¥ç¤¾å®˜ç¶²', url: 'https://kanahebi.cdx.jp/' }], note: '', address: 'å®®åŸç¸£å²©æ²¼å¸‚ä¸‰è‰²å‰å­—æ°´ç¥7', hours: '08:00 - 16:00 (åƒæ‹œ)', mapUrl: 'https://goo.gl/maps/Kanahebisui', cost: 1500, expanded: false },
                            { time: 'åƒæ‹œ', location: 'å¾¡å®ˆèˆ‡è³½éŒ¢', detail: 'ç¥ç¤¾åƒæ‹œè²»ç”¨ã€‚', note: '', cost: 1000, links: [], expanded: false }
                        ]
                    },
                    {
                        id: 'day4', date: '2/22', title: 'çƒå¸½å­æ»‘é›ª',
                        tip: 'è¨—é‹å–®å‹™å¿…å‚™è¨»ã€Œ2/24 Check-inï¼Œè—ç‹ä¸‰äº”éƒå°å±‹æ”¶ã€ã€‚',
                        checklist: [
                            { item: 'é ˜å–ç§Ÿè»Šèˆ‡ç¢ºèªå°èˆª', done: false },
                            { item: 'ç¢ºèª Ride Warpig 148cm é›ªæ¿å·²è£è¢‹', done: false },
                            { item: 'å¡«å¯«é»‘è²“å®…æ€¥ä¾¿è¨—é‹å–®', done: false }
                        ],
                        events: [
                            { time: '07:30', location: 'ä»™å°ç§Ÿè»Š', detail: 'ç§Ÿè»Šèˆ‡æ²¹è³‡åˆ†æ”¤ã€‚', note: '', cost: 8000, links: [], expanded: false },
                            { time: '09:00 - 15:30', location: 'çƒå¸½å­æ»‘é›ªå ´', detail: 'é›ªç¥¨èˆ‡æ´»å‹•è²»ç”¨ã€‚', links: [{ title: 'çƒå¸½å­æ»‘é›ªå ´å®˜ç¶²', url: 'https://www.eboshi.co.jp/' }], note: '', cost: 5500, expanded: false },
                            { time: '17:00', location: 'å¸‚å€é‚„è»Š', detail: 'è¿”å›å¸‚å€è¾¦ç†é‚„è»Šã€‚', note: '', cost: 0, links: [], expanded: false },
                            { time: 'ç‰©æµ', location: 'é»‘è²“/ä½å·æ€¥ä¾¿', detail: 'å¯„é€é›ªæ¿è‡³è—ç‹ã€‚', note: 'å¯„ä»¶æ™‚éœ€å‡ºç¤ºè­·ç…§', cost: 2500, links: [], expanded: false }
                        ]
                    },
                    {
                        id: 'day5', date: '2/23', title: 'éŠ€å±±æº«æ³‰',
                        tip: 'æ–°å¹¹ç·šè»Šæ¬¡è¼ƒå°‘ï¼Œè«‹å‹™å¿…æº–æ™‚ã€‚Tsubasa 133 ç‚ºå…¨è»ŠæŒ‡å®šå¸­ï¼Œå»ºè­°ææ—©åŠƒä½ã€‚',
                        checklist: [
                            { item: 'ç¢ºèªæ–°å¹¹ç·š Tsubasa 177 è»Šç¥¨', done: false },
                            { item: 'æº–å‚™æ›æ´—è¡£ç‰©éš¨èº«åŒ…', done: false }
                        ],
                        events: [
                            { time: '10:00 - 11:20', location: 'JR ä»™å±±ç·š', detail: 'ä»™å° -> å±±å½¢ç«™ã€‚', note: 'å¿«é€Ÿåˆ—è»Š', cost: 1170, links: [], expanded: false },
                            { time: '11:30 - 12:15', location: 'å±±å½¢ç«™å…§ (åˆé¤)', detail: 'æ¡è²·åˆé¤æˆ–è¼•é£Ÿã€‚', note: '', cost: 1200, links: [], expanded: false },
                            { time: '12:32 - 13:01', location: 'æ–°å¹¹ç·š Tsubasa 177', detail: 'å±±å½¢(12:32) - å¤§çŸ³ç”°(13:01)', note: 'åº§ä½: 13è»Š 4B', cost: 1450, links: [], expanded: false },
                            { time: '13:40', location: 'éŠ€å±±æº«æ³‰ ç€§è¦‹èˆ˜', detail: 'æ­ä¹˜æ¥é§è»Šå‰å¾€ (é€šå¸¸é…åˆæ–°å¹¹ç·šæ™‚é–“)ã€‚', links: [{ title: 'ç€§è¦‹èˆ˜é ç´„ç¢ºèª', url: 'https://www.takimikan.jp/' }], note: '', cost: 0, expanded: false }
                        ]
                    },
                    {
                        id: 'day6', date: '2/24', title: 'è½‰å¾€è—ç‹',
                        tip: 'æ³¨æ„ä¸‰äº”éƒå°å±‹çš„é›ªå ´æ¥é§æ™‚é–“ï¼Œé¿å…éŒ¯éæœ«ç­çºœè»Šã€‚',
                        checklist: [
                            { item: 'ç¢ºèªå±±äº¤å·´å£«æ™‚åˆ»è¡¨', done: false },
                            { item: 'èˆ‡ä¸‰äº”éƒå°å±‹ç¢ºèªé›ªåœ°æ¥é§', done: false },
                            { item: 'ç¢ºèªå®…æ€¥ä¾¿é›ªæ¿å·²æŠµé”', done: false }
                        ],
                        events: [
                            { time: '10:30', location: 'å¤§çŸ³ç”°ç«™', detail: 'æ­ä¹˜æ—…é¤¨æ¥é§è»Šå‰å¾€è»Šç«™ã€‚', note: '', cost: 0, links: [], expanded: false },
                            { time: '11:27 - 12:03', location: 'æ–°å¹¹ç·š Tsubasa 140', detail: 'å¤§çŸ³ç”°(11:27) - å±±å½¢(12:03)', note: 'åº§ä½: 13è»Š 3C', cost: 1450, links: [], expanded: false },
                            { time: '12:20 - 12:57', location: 'å±±äº¤å·´å£« (å±±å½¢-è—ç‹)', detail: 'å±±å½¢ç«™æ±å£ 1 è™Ÿä¹˜è»Šè™•ã€‚', links: [{ title: 'å±±äº¤å·´å£«æ™‚åˆ»è¡¨', url: 'https://www.yamakobus.jp/' }], note: '12:20 ç™¼è»Šï¼Œå…é ç´„', cost: 1000, expanded: false },
                            { time: '13:30', location: 'è—ç‹çºœè»Šå–®ç¨‹', detail: 'å‰å¾€ä¸‰äº”éƒå°å±‹ã€‚', note: '', cost: 1800, links: [], expanded: false },
                            { time: '14:30', location: 'è—ç‹ ä¸‰äº”éƒå°å±‹', detail: 'è¾¦ç† Check-inã€‚', links: [{ title: 'ä¸‰äº”éƒå°å±‹å®˜ç¶²', url: 'https://www.sangoro.co.jp/' }], note: '', cost: 0, expanded: false }
                        ]
                    },
                    {
                        id: 'day7', date: '2/25-27', title: 'è—ç‹æ»‘é›ª',
                        tip: 'é€£ä¸‰å¤©äº«å—è—ç‹ç²‰é›ªèˆ‡æ¨¹å†°ç¾æ™¯ã€‚',
                        checklist: [
                            { item: 'æª¢æŸ¥é›ªå…·èˆ‡é˜²å¯’è£å‚™', done: false },
                            { item: 'è³¼è²·è—ç‹å¤šæ—¥é›ªç¥¨', done: false },
                            { item: 'é€€æˆ¿å¾Œè¡Œæé€è‡³å±±å½¢å¤§å’Œé£¯åº—', done: false }
                        ],
                        events: [
                            { time: 'å…¨å¤©', location: 'è—ç‹ä¸‰æ—¥é›ªç¥¨', detail: 'æ»‘é›ªè¡Œç¨‹ç¥¨å·è²»ç”¨ã€‚', links: [{ title: 'è—ç‹é›ªå ´åœ°åœ–èˆ‡ç¥¨åƒ¹', url: 'https://www.zao-ski.or.jp/' }], note: '', cost: 18000, expanded: false },
                            { time: 'å…¨å¤©', location: 'é›ªå ´åˆé¤', detail: 'ä¸‰å¤©åˆé¤è²»ç”¨é ä¼°ã€‚', note: '', cost: 4500, links: [], expanded: false },
                            { time: '2/27 å‚æ™š', location: 'å±±äº¤å·´å£« (è—ç‹-å±±å½¢)', detail: 'é›¢é–‹è—ç‹ï¼Œè¿”å›å±±å½¢ç«™ã€‚', note: 'æ¯å°æ™‚ä¸€ç­ (:20æˆ–:40)', cost: 1000, links: [], expanded: false },
                            { time: 'ä½å®¿', location: 'å±±å½¢å¤§å’Œé£¯åº—', detail: 'è¾¦ç†å…¥ä½ã€‚', note: '', cost: 0, links: [], expanded: false }
                        ]
                    },
                    {
                        id: 'day8', date: '2/28', title: 'å±±å¯ºåƒè¨ª',
                        tip: 'å†¬å­£çŸ³éšæ¿•æ»‘ï¼Œç™»å±±å‹™å¿…è‘—å†°çˆªä¸¦æ³¨æ„æ­¥ä¼ã€‚',
                        checklist: [
                            { item: 'ç¢ºèªå†°çˆªå·²æ”¾å…¥éš¨èº«èƒŒåŒ…', done: false },
                            { item: 'ç©¿è‘—é˜²æ»‘é˜²æ°´é‹', done: false }
                        ],
                        events: [
                            { time: '09:00 - 09:20', location: 'JR ä»™å±±ç·š', detail: 'å±±å½¢-å±±å¯º-ä»™å° å…¨ç¨‹è»Šè³‡ã€‚', note: '', cost: 1500, links: [], expanded: false },
                            { time: '09:30 - 12:00', location: 'å±±å¯º (å¯¶ç å±± ç«‹çŸ³å¯º)', detail: 'è‘—è£å·²å‚™å¥½çš„å†°çˆªé€²è¡Œåƒæ‹œã€‚', links: [{ title: 'å±±å¯ºè§€å…‰å”æœƒ', url: 'https://www.yamaderakankou.com/' }], note: '', address: 'å±±å½¢ç¸£å±±å½¢å¸‚å±±å¯º4456-1', hours: '08:00 - 16:00', mapUrl: 'https://goo.gl/maps/Yamadera', cost: 300, expanded: false },
                            { time: 'ä¸­åˆ', location: 'åˆé¤', detail: 'ç•¶åœ°åˆé¤ã€‚', note: '', cost: 1500, links: [], expanded: false },
                            { time: 'ä¸‹åˆ', location: 'ç›¸éµ FRESA INN', detail: 'è¿”å›ä»™å°ä½å®¿ã€‚', note: '', cost: 0, links: [], expanded: false }
                        ]
                    },
                    {
                        id: 'day9', date: '3/1', title: 'è³¦æ­¸',
                        tip: 'IT255 19:40 èµ·é£›ï¼Œå»ºè­° 17:40 å‰æŠµé”æ©Ÿå ´ã€‚',
                        checklist: [
                            { item: 'ç¢ºèª IT255 èˆªç­å ±åˆ°æ™‚é–“', done: false },
                            { item: 'ç¢ºèªè¡Œæé‡é‡ä¸è¶…æ¨™', done: false },
                            { item: 'è³¼è²·ä¿å†·è¢‹è£å–œä¹…ç¦å¤§ç¦', done: false }
                        ],
                        events: [
                            { time: '10:00', location: 'ä¼´æ‰‹ç¦®æ¡è²·', detail: 'S-PAL ä»™å° (èŒ…ä¹ƒèˆç­‰)ã€‚', links: [{ title: 'S-PAL æ¨“å±¤æŒ‡å—', url: 'https://www.s-pal.jp/sendai/' }], note: 'æ¨è–¦è³¼è²·ï¼šè©ä¹‹æœˆ', cost: 10000, expanded: false },
                            { time: '12:00', location: 'åˆé¤ï¼šç±³æ¾¤ç‰›é»ƒæœ¨', detail: 'S-PAL åº—å…§äº«ç”¨åˆé¤ã€‚', note: '', cost: 4000, links: [], expanded: false },
                            { time: '17:00', location: 'ä»™å°ç©ºæ¸¯ç·š', detail: 'å‰å¾€æ©Ÿå ´è»Šè³‡ã€‚', note: 'é è¨ˆ 17:25 æŠµé”æ©Ÿå ´', cost: 660, links: [], expanded: false },
                            { time: '19:40', location: 'é›¢å¢ƒ IT255', detail: 'SDJ 19:40 - TPE 23:00', note: 'è¿”æŠµæ¡ƒåœ’æ©Ÿå ´', cost: 0, links: [], expanded: false }
                        ]
                    }
                ]
            }));
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        [x-cloak] { display: none !important; }
        .checkbox-custom { accent-color: #2563eb; width: 1.25rem; height: 1.25rem; cursor: pointer; }
        .input-clean {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .input-clean:hover { background: rgba(255,255,255,0.5); border-color: #cbd5e1; }
        .input-clean:focus { background: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Collapsible detail panel */
        .detail-panel {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease;
        }
        .detail-panel.open {
            grid-template-rows: 1fr;
        }
        .detail-panel > div { overflow: hidden; }

        /* Drag handle */
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        /* Chevron rotation */
        .chevron { transition: transform 0.3s ease; }
        .chevron.rotated { transform: rotate(180deg); }

        /* Row hover */
        .event-row:hover { background: rgba(241, 245, 249, 0.8); }
        .event-row { transition: background 0.15s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-blue-200" x-data="tripData()">

    <!-- Header -->
    <header class="relative h-64 flex items-center justify-center overflow-hidden">
        <img src="https://images.unsplash.com/photo-1480796927426-f609979314bd?q=80&w=2000" alt="Japan Winter" class="absolute inset-0 w-full h-full object-cover opacity-90">
        <div class="absolute inset-0 bg-gradient-to-b from-black/50 to-slate-50/90"></div>
        <div class="relative z-10 text-center px-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-widest drop-shadow-md mb-2">TOHOKU WINTER</h1>
            <p class="text-lg md:text-xl text-slate-100 font-medium tracking-wide drop-shadow">ä»™å°ãƒ»å±±å½¢ãƒ»è—ç‹ æ»‘é›ªç´€è¡Œ</p>
            <p class="text-sm text-slate-200 mt-2 font-mono">
                2026.02.19 - 03.01 |
                Â¥<span x-text="totalBudget.jpy.toLocaleString()"></span>
                <span class="text-slate-300 mx-1">â‰ˆ</span>
                NT$<span x-text="totalBudget.twd.toLocaleString()"></span>
            </p>
            <p class="mt-2 text-xs font-semibold tracking-wide" :class="syncColor" x-text="syncLabel"></p>
        </div>
    </header>

    <!-- Nav -->
    <nav class="sticky top-0 z-40 glass-card border-b border-slate-200 shadow-sm">
        <div class="flex overflow-x-auto px-4 py-3 gap-3 max-w-4xl mx-auto scroll-smooth snap-x hide-scrollbar">
            <template x-for="day in itinerary" :key="day.id">
                <button 
                    @click="activeDay = day.id" 
                    :class="activeDay === day.id ? 'bg-blue-600 text-white shadow-md scale-105' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-100'"
                    class="snap-start shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all duration-300 relative overflow-hidden mx-1 first:ml-0 last:mr-0">
                    <div :class="activeDay === day.id ? 'bg-blue-400' : 'bg-slate-200'" class="absolute top-0 w-full h-1.5 transition-colors"></div>
                    <template x-if="day.id === 'pre-trip'">
                        <div class="flex flex-col items-center mt-1">
                            <span class="text-[10px] font-bold opacity-80 uppercase tracking-wide">PRE</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                        </div>
                    </template>
                    <template x-if="day.id !== 'pre-trip'">
                        <div class="flex flex-col items-center leading-none mt-1">
                            <span class="text-[10px] uppercase font-bold opacity-70" x-text="day.date.split('/')[0] + 'æœˆ'"></span>
                            <span class="text-xl font-black tracking-tighter" x-text="parseInt(day.date.split('/')[1])"></span>
                        </div>
                    </template>
                </button>
            </template>
        </div>
    </nav>

    <!-- Main -->
    <main class="max-w-3xl mx-auto px-4 py-8 min-h-screen">

        <!-- Day Header -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-slate-800" x-text="currentDayData.date + ' ' + currentDayData.title"></h2>
            <template x-if="currentDayData.tip">
                <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r-lg text-sm text-blue-800 flex items-start gap-2">
                    <span>ğŸ’¡</span>
                    <span x-text="currentDayData.tip"></span>
                </div>
            </template>
        </div>

        <!-- Checklist + Budget -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">

            <!-- Checklist -->
            <div class="glass-card rounded-xl p-4 shadow-sm border-t-4 border-emerald-500 flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-emerald-800 flex items-center gap-2">
                        â˜‘ï¸ <span x-text="activeDay === 'pre-trip' ? 'ç¢ºèªæ¸…å–®' : 'æ¯æ—¥ç¢ºèªæ¸…å–®'"></span>
                    </h3>
                    <button @mousedown.prevent @click="addChecklistItem()"
                            class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200 transition-colors font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        æ–°å¢
                    </button>
                </div>
                <ul class="space-y-1 flex-grow pr-1">
                    <template x-for="(task, index) in currentDayData.checklist" :key="index">
                        <li :class="{
                                'pt-3 pb-1 border-b border-slate-200': ['ğŸ“‹','ğŸ“±','ğŸ’Š','ğŸ§¥','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‚','ğŸ“Œ'].some(e => task.item.startsWith(e)),
                                'pl-6': task.item.startsWith('  '),
                                'pl-1': !task.item.startsWith('  ') && !['ğŸ“‹','ğŸ“±','ğŸ’Š','ğŸ§¥','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‚','ğŸ“Œ'].some(e => task.item.startsWith(e))
                            }"
                            class="flex items-center gap-2 group">

                            <!-- Category header -->
                            <template x-if="['ğŸ“‹','ğŸ“±','ğŸ’Š','ğŸ§¥','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‚','ğŸ“Œ'].some(e => task.item.startsWith(e))">
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider flex-grow" x-text="task.item"></span>
                            </template>
                            <!-- + button on category header (pre-trip only) -->
                            <template x-if="['ğŸ“‹','ğŸ“±','ğŸ’Š','ğŸ§¥','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‚','ğŸ“Œ'].some(e => task.item.startsWith(e)) && activeDay === 'pre-trip'">
                                <button @click="addItemAfterCategory(index)"
                                        class="text-slate-300 hover:text-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity shrink-0 p-1" title="åœ¨æ­¤é¡åˆ¥æ–°å¢é …ç›®">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/></svg>
                                </button>
                            </template>

                            <!-- Sub-item -->
                            <template x-if="task.item.startsWith('  ')">
                                <span class="text-slate-300 shrink-0 text-xs">â””</span>
                            </template>
                            <template x-if="task.item.startsWith('  ')">
                                <input type="checkbox" x-model="task.done" class="checkbox-custom shrink-0">
                            </template>
                            <template x-if="task.item.startsWith('  ')">
                                <span :class="task.done ? 'line-through text-slate-400' : 'text-slate-500'"
                                      class="text-sm transition-all flex-grow truncate"
                                      x-text="task.item.trim()"></span>
                            </template>

                            <!-- Regular item -->
                            <template x-if="!task.item.startsWith('  ') && !['ğŸ“‹','ğŸ“±','ğŸ’Š','ğŸ§¥','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‚','ğŸ“Œ'].some(e => task.item.startsWith(e))">
                                <input type="checkbox" x-model="task.done" class="checkbox-custom shrink-0">
                            </template>
                            <template x-if="!task.item.startsWith('  ') && !['ğŸ“‹','ğŸ“±','ğŸ’Š','ğŸ§¥','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‚','ğŸ“Œ'].some(e => task.item.startsWith(e))">
                                <span :class="task.done ? 'line-through text-slate-400' : 'text-slate-700'"
                                      class="text-sm transition-all flex-grow truncate"
                                      x-text="task.item"></span>
                            </template>

                            <!-- Delete -->
                            <button @click="removeChecklistItem(index)"
                                    class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity shrink-0 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg>
                            </button>
                        </li>
                    </template>
                </ul>
                <!-- Add row: show type toggle only on pre-trip -->
                <div class="mt-3 pt-3 border-t border-emerald-100">
                    <template x-if="activeDay === 'pre-trip'">
                        <div class="flex gap-1 mb-2">
                            <button @mousedown.prevent @click="newChecklistType = 'item'"
                                    :class="newChecklistType === 'item' ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'"
                                    class="text-xs px-2.5 py-1 rounded-full font-semibold transition-colors">
                                â˜‘ é …ç›®
                            </button>
                            <button @mousedown.prevent @click="newChecklistType = 'category'"
                                    :class="newChecklistType === 'category' ? 'bg-slate-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'"
                                    class="text-xs px-2.5 py-1 rounded-full font-semibold transition-colors">
                                ğŸ“Œ é¡åˆ¥
                            </button>
                        </div>
                    </template>
                    <div class="flex items-center gap-2">
                        <input :id="'checklist-input-' + activeDay"
                               type="text"
                               x-model="newChecklistItem"
                               @keydown.enter="addChecklistItem()"
                               :placeholder="newChecklistType === 'category' ? 'è¼¸å…¥é¡åˆ¥åç¨±...' : 'è¼¸å…¥ç¢ºèªé …ç›®...'"
                               class="flex-grow bg-transparent border border-transparent hover:border-slate-200 focus:border-emerald-400 focus:bg-white rounded px-2 py-1 text-sm focus:outline-none transition-all placeholder-slate-300">
                        <button @mousedown.prevent @click="addChecklistItem()"
                                class="text-slate-300 hover:text-emerald-500 transition-colors shrink-0 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Budget -->
            <div class="glass-card rounded-xl p-4 shadow-sm border-t-4 border-amber-500 flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-amber-800 flex items-center gap-2">ğŸ’° æœ¬æ—¥æ”¯å‡º (JPY)</h3>
                    <button @click="addExpense()" class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded hover:bg-amber-200 transition-colors font-bold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        æ–°å¢
                    </button>
                </div>
                <ul class="space-y-0.5 flex-grow overflow-y-auto max-h-64 pr-1">
                    <!-- Events with cost (now editable + deletable, same layout) -->
                    <template x-for="event in currentDayData.events.filter(e => String(e.cost||'').trim() && String(e.cost||'').trim() !== '0')" :key="'ev-' + event.id">
                        <li class="flex items-center gap-2 text-sm border-b border-slate-100 pb-1 group">
                            <input type="text" x-model="event.location"
                                   class="bg-transparent hover:bg-white focus:bg-white border border-transparent hover:border-slate-200 focus:border-blue-300 rounded px-1 py-0.5 flex-grow min-w-0 truncate focus:outline-none transition-all text-slate-600 text-sm">
                            <input type="text" x-model="event.cost"
                                   class="w-24 shrink-0 bg-transparent hover:bg-white focus:bg-white border border-transparent hover:border-slate-200 focus:border-blue-300 rounded px-1 py-0.5 text-right font-mono focus:outline-none transition-all text-slate-700 text-sm"
                                   placeholder="0">
                            <button @click="removeEventById(event.id)"
                                    class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1 shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg>
                            </button>
                        </li>
                    </template>
                    <!-- Extra expense-only items -->
                    <template x-for="exp in (currentDayData.expenses || [])" :key="'xp-' + exp.id">
                        <li class="flex items-center gap-2 text-sm border-b border-slate-100 pb-1 group">
                            <input type="text" x-model="exp.location"
                                   class="bg-transparent hover:bg-white focus:bg-white border border-transparent hover:border-slate-200 focus:border-blue-300 rounded px-1 py-0.5 flex-grow min-w-0 truncate focus:outline-none transition-all text-slate-600 text-sm">
                            <input type="text" x-model="exp.cost"
                                   class="w-24 shrink-0 bg-transparent hover:bg-white focus:bg-white border border-transparent hover:border-slate-200 focus:border-blue-300 rounded px-1 py-0.5 text-right font-mono focus:outline-none transition-all text-slate-700 text-sm"
                                   placeholder="0 æˆ– NT500">
                            <button @click="removeExpenseById(exp.id)"
                                    class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1 shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg>
                            </button>
                        </li>
                    </template>
                    <li x-show="currentDayData.events.filter(e => e.cost > 0).length === 0 && (currentDayData.expenses || []).length === 0"
                        class="text-slate-400 text-sm italic py-2 text-center">å°šç„¡æ”¯å‡ºé …ç›®</li>
                </ul>
                <div class="mt-4 pt-3 border-t border-slate-200 space-y-1.5">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">æœ¬æ—¥ç¸½è¨ˆ (JPY)</span>
                        <span class="font-mono text-base font-bold text-slate-800">Â¥ <span x-text="currentDayTotal.jpy.toLocaleString()"></span></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">æŠ˜åˆå°å¹£ <span class="text-xs text-slate-400">(Ã—0.21)</span></span>
                        <span class="font-mono text-base font-bold text-emerald-700">NT$ <span x-text="currentDayTotal.twd.toLocaleString()"></span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collapsible Timeline -->
        <div x-show="activeDay !== 'pre-trip'" class="glass-card rounded-2xl overflow-hidden shadow-sm mb-8">

            <!-- Column Headers -->
            <div class="flex items-center gap-3 px-4 py-2 bg-slate-100/80 border-b border-slate-200 text-xs font-bold text-slate-400 uppercase tracking-wider">
                <div class="w-5"></div><!-- drag handle -->
                <div class="w-5"></div><!-- dot -->
                <div class="w-24 shrink-0">æ™‚é–“</div>
                <div class="flex-grow">è¡Œç¨‹</div>
                <div class="w-24 text-right shrink-0">è²»ç”¨ (Â¥)</div>
                <!-- Single toggle button: expand all if any collapsed, collapse all if all expanded -->
                <button @click="currentDayData.events.some(e => !e.expanded) ? currentDayData.events.forEach(e => e.expanded = true) : currentDayData.events.forEach(e => e.expanded = false)"
                        :title="currentDayData.events.some(e => !e.expanded) ? 'å…¨éƒ¨å±•é–‹' : 'å…¨éƒ¨æ”¶ç–Š'"
                        class="p-1 rounded hover:bg-slate-200 transition-colors text-slate-400 hover:text-slate-600 shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5">
                        <path x-show="currentDayData.events.some(e => !e.expanded)" fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.24a.75.75 0 011.06.04L10 15.148l2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z" clip-rule="evenodd"/>
                        <path x-show="!currentDayData.events.some(e => !e.expanded)" fill-rule="evenodd" d="M14.77 4.21a.75.75 0 01.02 1.06l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 011.08-1.02L10 8.168l3.71-3.938a.75.75 0 011.06-.02zm0 10a.75.75 0 01.02 1.06l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 111.08-1.02L10 18.168l3.71-3.938a.75.75 0 011.06-.02z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <div class="w-5"></div><!-- delete col -->
            </div>

            <div id="sortable-events">
            <template x-for="(event, index) in currentDayData.events" :key="event.id">
                <div class="border-b border-slate-100 last:border-b-0">

                    <!-- Summary Row (always visible) -->
                    <div class="event-row flex items-center gap-3 px-4 py-3 cursor-pointer select-none group"
                         @click="toggleEvent(event)">

                        <!-- Drag Handle -->
                        <div class="drag-handle w-5 shrink-0 text-slate-300 hover:text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity" @click.stop>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path d="M7 2a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM13 2a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM7 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM13 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM7 15a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM13 15a1.5 1.5 0 110 3 1.5 1.5 0 010-3z"/>
                            </svg>
                        </div>

                        <!-- Color Dot -->
                        <div class="w-2.5 h-2.5 rounded-full shrink-0"
                             :class="event.cost > 0 ? 'bg-amber-400' : 'bg-blue-400'"></div>

                        <!-- Time -->
                        <div class="w-24 shrink-0 font-mono text-sm font-semibold text-blue-600 truncate"
                             x-text="event.time || 'â€”'"></div>

                        <!-- Location -->
                        <div class="flex-grow font-medium text-slate-700 truncate text-sm"
                             x-text="event.location"></div>

                        <!-- Cost -->
                        <div class="w-24 text-right shrink-0 font-mono text-sm"
                             :class="(String(event.cost||'')).trim() ? 'text-amber-600 font-bold' : 'text-slate-300'"
                             x-text="(function(){
                                const s = String(event.cost||'').trim();
                                if(!s || s==='0') return 'â€”';
                                if(/^NT\s*/i.test(s)) return 'NT$' + (parseFloat(s.replace(/^NT\s*/i,''))||0).toLocaleString();
                                return 'Â¥' + (parseFloat(s)||0).toLocaleString();
                             })()"></div>

                        <!-- Chevron -->
                        <div :class="event.expanded ? 'rotated' : ''" class="chevron w-5 h-5 text-slate-400 shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z" clip-rule="evenodd" />
                            </svg>
                        </div>

                        <!-- Delete -->
                        <button @click.stop="removeEventById(event.id)"
                                class="w-5 h-5 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Detail Panel (collapsible) -->
                    <div :class="event.expanded ? 'open' : ''" class="detail-panel">
                        <div>
                            <div class="px-5 pb-5 pt-2 bg-slate-50/70 border-t border-slate-100">
                                
                                <!-- Editable Fields -->
                                <div class="flex flex-col md:flex-row md:items-baseline gap-2 mb-3">
                                    <input type="text" x-model="event.time"
                                           class="input-clean text-blue-600 font-black tracking-tight w-full md:w-32 text-sm placeholder-blue-300"
                                           placeholder="æ™‚é–“" @click.stop>
                                    <input type="text" x-model="event.location"
                                           class="input-clean text-base font-bold text-slate-800 flex-grow"
                                           placeholder="åœ°é»/æ´»å‹•åç¨±" @click.stop>
                                </div>

                                <textarea x-model="event.detail" rows="2" @click.stop
                                          class="input-clean w-full text-slate-600 text-sm leading-relaxed mb-3 resize-none"
                                          placeholder="è¡Œç¨‹ç´°ç¯€..."></textarea>

                                <!-- Address & Hours -->
                                <div x-show="event.address || event.hours" class="flex flex-wrap gap-y-1 gap-x-4 mb-3">
                                    <template x-if="event.address">
                                        <div class="flex items-center gap-1 text-xs text-slate-500">
                                            <span>ğŸ“</span><span x-text="event.address"></span>
                                        </div>
                                    </template>
                                    <template x-if="event.hours">
                                        <div class="flex items-center gap-1 text-xs text-slate-500">
                                            <span>ğŸ•’</span><span x-text="event.hours"></span>
                                        </div>
                                    </template>
                                </div>

                                <!-- Links -->
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <template x-if="event.mapUrl">
                                        <a :href="event.mapUrl" target="_blank" rel="noopener noreferrer" @click.stop
                                           class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-100 text-blue-700 text-xs font-bold rounded-lg hover:bg-blue-200 transition-colors">
                                            ğŸ—ºï¸ Google Maps
                                        </a>
                                    </template>
                                    <template x-if="event.links && event.links.length > 0">
                                        <template x-for="link in event.links">
                                            <a :href="link.url" target="_blank" rel="noopener noreferrer" @click.stop
                                               class="inline-flex items-center gap-1 px-3 py-1.5 bg-slate-800 text-white text-xs font-semibold rounded-lg hover:bg-blue-600 transition-colors">
                                                ğŸ”— <span x-text="link.title"></span>
                                            </a>
                                        </template>
                                    </template>
                                </div>

                                <!-- Note & Cost -->
                                <div class="flex flex-col sm:flex-row sm:items-center gap-3 pt-3 border-t border-slate-200">
                                    <div class="flex items-center gap-2 flex-grow">
                                        <span class="text-xs text-slate-400 whitespace-nowrap">ğŸ“ å‚™è¨»</span>
                                        <input type="text" x-model="event.note" @click.stop
                                               class="input-clean w-full text-xs text-slate-500 border-b border-transparent focus:border-blue-200"
                                               placeholder="é»æ“Šæ–°å¢å‚™è¨»...">
                                    </div>
                                    <div class="flex items-center gap-2 shrink-0">
                                        <label class="text-xs font-bold text-slate-400">ğŸ’° è²»ç”¨</label>
                                        <input type="text" x-model="event.cost" @click.stop
                                               class="w-28 bg-white border border-slate-200 rounded-md py-1 px-2 text-right text-sm font-mono text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder:text-slate-300"
                                               placeholder="0 æˆ– NT500">
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </template>
            </div><!-- end sortable-events -->

            <!-- Add Event Button -->
            <div class="p-3">
                <button @click="addEvent()"
                        class="w-full py-2.5 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50/50 transition-all flex items-center justify-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                    </svg>
                    æ–°å¢è¡Œç¨‹
                </button>
            </div>
        </div>

    </main>
</body>
</html>
